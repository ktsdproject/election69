<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Election Quest Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- 1. CORE LAYOUT --- */
        html { /* Font size handled by JS */ }
        body {
            font-family: 'Mali', cursive;
            background-color: #202020;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        .game-frame {
            position: relative; overflow: hidden;
            background-color: #f0f4f8;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            width: 95vw; height: calc(95vw * 1708 / 960);
            max-width: 500px; max-height: 890px;
            margin: auto; border-radius: 2rem;
            display: flex; flex-direction: column; /* ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (Nav ‡∏ö‡∏ô, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡∏•‡πà‡∏≤‡∏á) */
        }
        @media (min-aspect-ratio: 960/1708) {
            .game-frame { height: 90vh; width: calc(90vh * 960 / 1708); }
        }

        /* --- 2. TOP TAB BAR (Sheet Style) --- */
        .top-nav {
            flex-shrink: 0; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏î */
            height: 6rem;
            background: #fff;
            display: flex;
            box-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.05);
            z-index: 100;
        }
        .nav-tab {
            flex: 1; border: none; background: #f4f6f8;
            font-family: 'Mali', cursive;
            font-size: 1.8rem; font-weight: bold; color: #888;
            cursor: pointer; position: relative;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            border-bottom: 0.4rem solid transparent;
        }
        .nav-tab:hover { background: #eee; }
        
        /* Active State */
        .nav-tab.active {
            background: #fff;
            color: #4ECDC4;
            border-bottom: 0.4rem solid #4ECDC4;
        }

        /* --- 3. CONTENT AREA --- */
        .content-area {
            flex: 1; /* ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
            position: relative;
            overflow: hidden;
        }

        .tab-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
            flex-direction: column;
        }
        .tab-view.active { display: flex; }

        /* --- 4. TIMELINE VIEW STYLES --- */
        #view-timeline {
            overflow-y: auto; /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ */
            padding: 2rem;
            background: #fff;
        }
        .timeline-header {
            text-align: center; margin-bottom: 3rem; margin-top: 1rem;
        }
        
        .timeline-item { display: flex; gap: 1.5rem; position: relative; padding-bottom: 3rem; }
        .timeline-item::before {
            content: ''; position: absolute; left: 1.4rem; top: 3.5rem; bottom: 0;
            width: 0.3rem; background: #e0e0e0; z-index: 0;
        }
        .timeline-item:last-child::before { display: none; }

        .t-circle {
            width: 3.5rem; height: 3.5rem; border-radius: 50%; flex-shrink: 0; z-index: 1;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; color: white; border: 0.3rem solid white;
            box-shadow: 0 0.3rem 0.5rem rgba(0,0,0,0.1);
        }
        
        /* Status Colors */
        .t-status-done .t-circle { background: #4CAF50; }
        .t-status-active .t-circle { background: #FF9800; animation: pulse 1.5s infinite; }
        .t-status-future .t-circle { background: #ddd; color: #aaa; }
        
        .t-content h3 { font-size: 2rem; font-weight: bold; margin: 0; color: #333; }
        .t-content p { font-size: 1.6rem; color: #666; margin: 0.2rem 0; }
        .t-content .t-date { font-size: 1.4rem; font-weight: 600; color: #888; margin-bottom: 0.5rem; display: block; }
        .t-status-active .t-content h3, .t-status-active .t-content .t-date { color: #FF9800; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 1rem rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }

        /* --- 5. MAP VIEW STYLES --- */
        #map { width: 100%; height: 100%; z-index: 1; }
        
        .filter-container {
            position: absolute; top: 2rem; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 1rem;
            z-index: 500; padding: 0 2rem; box-sizing: border-box;
            pointer-events: none; /* ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á */
        }
        .filter-btn {
            pointer-events: auto; /* ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ */
            background: white; border: 0.2rem solid #ddd;
            padding: 0.8rem 1.5rem; border-radius: 2rem;
            font-size: 1.6rem; font-weight: bold; color: #555;
            box-shadow: 0 0.4rem 0.5rem rgba(0,0,0,0.1); cursor: pointer;
        }
        .filter-btn.active { background: #4ECDC4; border-color: #4ECDC4; color: white; }

        .leaflet-control-zoom { border: none !important; margin-bottom: 15rem !important; margin-right: 2rem !important; }
        .leaflet-control-zoom a {
            background-color: #FFD700 !important; color: #333 !important;
            border-radius: 1rem !important; width: 4rem !important; height: 4rem !important;
            line-height: 4rem !important; font-size: 2.5rem !important;
            box-shadow: 0 0.5rem 0 #cba800 !important; margin-bottom: 1rem !important;
        }

        /* --- 6. POPUP DETAILS (Bottom Sheet) --- */
        .info-popup-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 1000; display: flex; justify-content: center; align-items: flex-end;
            opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .info-popup-overlay.visible { opacity: 1; visibility: visible; }
        .info-card {
            background: white; width: 100%; height: 75%;
            border-radius: 4rem 4rem 0 0; padding: 3rem;
            transform: translateY(100%); transition: transform 0.3s ease-out;
            display: flex; flex-direction: column; position: relative;
        }
        .info-popup-overlay.visible .info-card { transform: translateY(0); }

        .close-btn-circle {
            position: absolute; top: 2rem; right: 2rem;
            background: #eee; width: 4rem; height: 4rem;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: #555; cursor: pointer;
        }

        /* Gallery & Badges */
        .gallery-scroll {
            display: flex; overflow-x: auto; gap: 1.5rem; padding: 1rem 0; margin-top: 2rem;
            scroll-snap-type: x mandatory;
        }
        .gallery-scroll::-webkit-scrollbar { display: none; }
        .gallery-scroll img {
            height: 15rem; width: auto; border-radius: 1.5rem;
            scroll-snap-align: start; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
        }
        .badge { display: inline-block; padding: 0.5rem 1.5rem; border-radius: 2rem; font-size: 1.8rem; font-weight: bold; margin-right: 1rem; }
        .badge-out { background: #FFE5D9; color: #D64545; }
        .badge-in { background: #E3F2FD; color: #1E88E5; }

    </style>
</head>
<body>

    <div class="game-frame">
        
        <nav class="top-nav">
            <button class="nav-tab active" onclick="switchTab('timeline', this)">
                üìÖ ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå
            </button>
            <button class="nav-tab" onclick="switchTab('map', this)">
                üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            </button>
        </nav>

        <div class="content-area">
            
            <div id="view-timeline" class="tab-view active">
                <div class="timeline-header">
                    <h1 style="font-size: 3rem; margin:0; color:#333;">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</h1>
                    <p style="font-size: 1.6rem; color:#888;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
                </div>
                <div id="timeline-container">
                    </div>
                <button onclick="document.querySelectorAll('.nav-tab')[1].click()" 
                    style="width: 100%; font-size: 2rem; padding: 1.5rem; margin-top: 2rem; margin-bottom: 2rem;
                        background: #eee; color: #555; border: none; border-radius: 2rem; font-weight: bold;
                        cursor: pointer;">
                    ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà üëâ
                </button>
            </div>

            <div id="view-map" class="tab-view">
                <div class="filter-container">
                    <button class="filter-btn active" onclick="filterMap('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button class="filter-btn" onclick="filterMap('out', this)">‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</button>
                    <button class="filter-btn" onclick="filterMap('in', this)">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</button>
                </div>
                <div id="map"></div>
            </div>

        </div>

        <div id="info-overlay" class="info-popup-overlay" onclick="closePopup(event)">
            <div class="info-card" onclick="event.stopPropagation()">
                <div class="close-btn-circle" onclick="closePopupDirect()">‚úï</div>
                
                <h2 id="p-name" style="font-size: 3rem; font-weight: 700; color: #333; line-height: 1.2;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h2>
                <p id="p-sub" style="font-size: 2rem; color: #888; margin-top: 0.5rem;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢</p>
                
                <div style="margin-top: 2rem;">
                    <span id="p-type" class="badge badge-out">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>
                    <span id="p-unit" style="font-size: 1.8rem; color: #555;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>
                </div>

                <div id="p-gallery" class="gallery-scroll"></div>

                <div style="margin-top: 2rem; padding: 2rem; background: #f9f9f9; border-radius: 2rem; border: 2px dashed #ddd;">
                    <p style="font-size: 1.6rem; font-weight: 700; color: #555;">Note:</p>
                    <p id="p-note" style="font-size: 1.8rem; color: #333;">-</p>
                </div>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DATA ---
        const timelineData = [
            {
                dateText: "12 ‡∏ò.‡∏Ñ. 68",
                title: "‡∏¢‡∏∏‡∏ö‡∏™‡∏†‡∏≤",
                desc: "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏¢‡∏∏‡∏ö‡∏™‡∏†‡∏≤‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡∏£‡∏≤‡∏©‡∏é‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà",
                startDate: new Date("2025-12-12T00:00:00"),
                endDate: new Date("2025-12-12T23:59:59")
            },
            {
                dateText: "15 ‡∏ò.‡∏Ñ. 68",
                title: "‡∏Å‡∏Å‡∏ï. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á",
                desc: "‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á",
                startDate: new Date("2025-12-15T00:00:00"),
                endDate: new Date("2025-12-15T23:59:59")
            },
            {
                dateText: "27-31 ‡∏ò.‡∏Ñ. 68",
                title: "‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏™.‡∏™.",
                desc: "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏†‡∏≤‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡∏£‡∏≤‡∏©‡∏é‡∏£ (08.30 - 16.30 ‡∏ô.)",
                startDate: new Date("2025-12-27T08:30:00"),
                endDate: new Date("2025-12-31T16:30:00")
            },
            {
                dateText: "1 ‡∏Å.‡∏û. 69", 
                title: "‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á üó≥Ô∏è",
                desc: "‡∏ß‡∏±‡∏ô‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á (08.00 - 17.00 ‡∏ô.)",
                startDate: new Date("2026-02-01T08:00:00"),
                endDate: new Date("2026-02-01T17:00:00")
            }
        ];

        const units = [
            {
                "id": 1,
                "name": "‡∏•‡∏≤‡∏ô‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏ï‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏™‡∏π‡∏ö",
                "name_details": "‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏´‡∏†‡∏≤‡∏û‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô",
                "unit_count": "3 ‡∏´‡∏ô‡πà‡∏ß‡∏¢",
                "lat": 13.724167, "lng": 100.554444,
                "images": ["https://placehold.co/400x300/orange/white?text=‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà1"],
                "details_range": "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1-3",
                "location_type": "‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£",
                "note": "‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà"
            },
            {
                "id": 2,
                "name": "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢",
                "name_details": "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 1 ‡∏ä‡∏±‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á",
                "unit_count": "1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢",
                "lat": 13.718500, "lng": 100.559200,
                "images": [],
                "details_range": "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 4",
                "location_type": "‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£",
                "note": "-"
            },
             {
                "id": 3,
                "name": "‡∏ß‡∏±‡∏î‡∏™‡∏∞‡∏û‡∏≤‡∏ô",
                "name_details": "‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏î",
                "unit_count": "2 ‡∏´‡∏ô‡πà‡∏ß‡∏¢",
                "lat": 13.710000, "lng": 100.590000,
                "images": [],
                "details_range": "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 5-6",
                "location_type": "‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£",
                "note": "-"
            }
        ];

        let map, markers = [];

        // --- 1. TAB SYSTEM ---
        function switchTab(tabId, btn) {
            // Update Buttons (‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°)
            if(btn) {
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            // Hide all views
            document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
            
            // Show target view
            document.getElementById('view-' + tabId).classList.add('active');

            // Special Case: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ Map render ‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å Map ‡πÄ‡∏ó‡∏≤)
            if(tabId === 'map' && map) {
                setTimeout(() => { map.invalidateSize(); }, 100);
            }
        }

        // --- 2. LOGIC: SCALING & DATA ---
        function adjustGameScaling() {
            const gameFrame = document.querySelector('.game-frame');
            if (!gameFrame) return;
            const designWidth = 960;
            const currentWidth = gameFrame.offsetWidth;
            const scaleRatio = currentWidth / designWidth;
            document.documentElement.style.fontSize = `${10 * scaleRatio}px`;
            if(map) setTimeout(() => map.invalidateSize(), 300);
        }

        function initTimeline() {
            const container = document.getElementById('timeline-container');
            const now = new Date(); 
            // const now = new Date("2025-12-28T10:00:00"); // Uncomment to test active date

            let html = '';
            timelineData.forEach(item => {
                let statusClass = 't-status-future';
                let icon = 'üîí';

                if (now > item.endDate) {
                    statusClass = 't-status-done'; icon = '‚úì';
                } else if (now >= item.startDate && now <= item.endDate) {
                    statusClass = 't-status-active'; icon = 'üî•';
                }

                html += `
                    <div class="timeline-item ${statusClass}">
                        <div class="t-circle">${icon}</div>
                        <div class="t-content">
                            <span class="t-date">${item.dateText}</span>
                            <h3>${item.title}</h3>
                            ${item.desc ? `<p>${item.desc}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- 3. LOGIC: MAP ---
        function initMap() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡πÉ‡∏ô div id="map"
            map = L.map('map', { zoomControl: true }).setView([13.720, 100.555], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬©OpenStreetMap, ¬©CartoDB', maxZoom: 19
            }).addTo(map);
            renderMarkers(units);
        }

        function renderMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            data.forEach(unit => {
                let typeColor = unit.location_type.includes("‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å") ? "red" : "blue";
                let customIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="
                        background-color: ${typeColor === 'red' ? '#FF6B6B' : '#4ECDC4'};
                        width: 3rem; height: 3rem; border-radius: 50%; border: 0.3rem solid white;
                        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.3);
                        display: flex; justify-content: center; align-items: center; font-size: 1.5rem;
                    ">${typeColor === 'red' ? '‚òÄÔ∏è' : 'üè¢'}</div>`,
                    iconSize: [30, 30], iconAnchor: [15, 15]
                });
                let marker = L.marker([unit.lat, unit.lng], { icon: customIcon })
                    .addTo(map).on('click', () => openPopup(unit));
                markers.push(marker);
            });
        }

        function filterMap(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (type === 'all') renderMarkers(units);
            else if (type === 'out') renderMarkers(units.filter(u => u.location_type.includes("‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å")));
            else if (type === 'in') renderMarkers(units.filter(u => u.location_type.includes("‡∏†‡∏≤‡∏¢‡πÉ‡∏ô")));
        }

        // --- 4. POPUP DETAIL ---
        function openPopup(data) {
            document.getElementById('p-name').innerText = data.name;
            document.getElementById('p-sub').innerText = data.name_details;
            document.getElementById('p-unit').innerText = data.unit_count;
            document.getElementById('p-note').innerText = data.note;
            
            const typeBadge = document.getElementById('p-type');
            if(data.location_type.includes("‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å")) {
                typeBadge.className = "badge badge-out"; typeBadge.innerText = "‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
            } else {
                typeBadge.className = "badge badge-in"; typeBadge.innerText = "‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
            }

            const gallery = document.getElementById('p-gallery');
            gallery.innerHTML = '';
            if (data.images.length > 0) {
                data.images.forEach(img => {
                    gallery.innerHTML += `<img src="${img}" onclick="window.open('${img}')">`;
                });
            } else {
                gallery.innerHTML = `<div style="width:100%; height:10rem; background:#eee; border-radius:1.5rem; display:flex; justify-content:center; align-items:center; color:#999; font-size:1.6rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>`;
            }
            document.getElementById('info-overlay').classList.add('visible');
        }

        function closePopup(e) { if (e.target.id === 'info-overlay') closePopupDirect(); }
        function closePopupDirect() { document.getElementById('info-overlay').classList.remove('visible'); }

        // --- INIT ---
        window.addEventListener('load', () => {
            adjustGameScaling();
            initTimeline();
            initMap();
        });
        window.addEventListener('resize', adjustGameScaling);

    </script>
</body>
</html>
